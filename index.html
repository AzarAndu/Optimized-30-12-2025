<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spare Parts Search</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
:root{
  --bg:#f5f6fa; --card:#fff; --primary:#007bff; --text:#222;
  --dark-bg:#1f2933; --dark-card:#2d3748; --dark-text:#e5e7eb;
}
body{font-family:Arial;margin:16px;background:var(--bg);color:var(--text);}
body.dark{background:var(--dark-bg);color:var(--dark-text);}
h2{margin:0 0 10px;font-size:26px}
.topbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#e5e7eb}
#search{width:100%;max-width:420px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#e6e9f0}
.compact th,.compact td{padding:6px;font-size:13px}
body.dark table{background:var(--dark-card)}
body.dark th{background:#111827;color:var(--dark-text)}
.pagination{margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.highlight{background:#ffeaa7!important;font-weight:bold}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;padding:14px;border-radius:10px;width:95%;max-width:400px}
#qr-reader{width:100%;height:220px}
</style>
</head>

<body>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btnScan" class="btn btn-primary">ðŸ“· Scan</button>
  <button id="btnRefresh" class="btn btn-secondary">â†» Refresh</button>
  <button id="btnExport" class="btn btn-secondary">â¬‡ Export CSV</button>
  <label>Dark <input type="checkbox" id="darkToggle"></label>
  <label>Compact <input type="checkbox" id="compactToggle"></label>
</div>

<input id="search" placeholder="Search item / part / description / category / qty">

<table>
<thead>
<tr>
  <th>#</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="pagination">
  <button id="prev" class="btn btn-secondary">Prev</button>
  <span id="pageInfo"></span>
  <button id="next" class="btn btn-secondary">Next</button>
  <input id="jump" type="number" placeholder="Page #" style="width:80px">
  <button id="jumpBtn" class="btn btn-secondary">Go</button>
</div>

<!-- SCANNER -->
<div id="qrBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Scan Code</h3>
    <div id="qr-reader"></div>
    <button id="qrClose" class="btn btn-secondary">Close</button>
  </div>
</div>

<!-- LOUD SUCCESS SOUND -->
<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ===== DOM ===== */
const tbody = document.getElementById("tbody");
const search = document.getElementById("search");
const pageInfo = document.getElementById("pageInfo");

const btnScan = document.getElementById("btnScan");
const btnRefresh = document.getElementById("btnRefresh");
const btnExport = document.getElementById("btnExport");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const jumpBtn = document.getElementById("jumpBtn");
const jumpInput = document.getElementById("jump");

const darkToggle = document.getElementById("darkToggle");
const compactToggle = document.getElementById("compactToggle");

const qrBackdrop = document.getElementById("qrBackdrop");
const qrClose = document.getElementById("qrClose");
const beep = document.getElementById("beep");

/* ===== CONFIG ===== */
const URL = "https://sheetdb.io/api/v1/bvdsyfvkla1lv";
let all = [], page = 1, perPage = 50;
let scanner = null, highlightValue = null;

/* ===== UTIL ===== */
function cleanKeys(o){
  const r = {};
  for(const k in o) r[k.trim()] = o[k];
  return r;
}

/* ===== CACHE ===== */
function saveCache(d){ localStorage.setItem("spare_cache", JSON.stringify(d)); }
function loadCache(){ return JSON.parse(localStorage.getItem("spare_cache")||"[]"); }

/* ===== LOAD ===== */
async function load(){
  try{
    const res = await fetch(URL);
    const json = await res.json();
    all = prepare(json);
    saveCache(all);
  }catch{
    all = loadCache();
    alert("Offline mode: loaded cached data");
  }
  page = 1;
  render();
}

/* ===== PREP ===== */
function prepare(json){
  return json.map(x=>{
    const r = cleanKeys(x);
    r._s = (
      (r["item no"]||"") + " " +
      (r["part no"]||"") + " " +
      (r["description"]||"") + " " +
      (r["category"]||"") + " " +
      (r["qty"]||"")
    ).toLowerCase();
    return r;
  });
}

/* ===== RENDER ===== */
function render(){
  const q = search.value.toLowerCase();
  const list = q ? all.filter(r=>r._s.includes(q)) : all;

  const pages = Math.max(1, Math.ceil(list.length / perPage));
  if(page > pages) page = pages;

  const start = (page-1)*perPage;
  const view = list.slice(start, start+perPage);

  tbody.innerHTML = view.map((r,i)=>`
    <tr class="${highlightValue && r._s.includes(highlightValue.toLowerCase()) ? "highlight":""}">
      <td>${start+i+1}</td>
      <td>${r["item no"]||""}</td>
      <td>${r["part no"]||""}</td>
      <td>${r["description"]||""}</td>
      <td>${r["category"]||""}</td>
      <td>${r["qty"]||""}</td>
    </tr>
  `).join("");

  pageInfo.textContent = `Page ${page} of ${pages} (${list.length})`;
}

/* ===== SEARCH (DEBOUNCED) ===== */
let searchTimer;
search.oninput = ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{
    page = 1;
    render();
  }, 200);
};

/* ===== PAGINATION ===== */
prevBtn.onclick = ()=>{ if(page>1){ page--; render(); }};
nextBtn.onclick = ()=>{ page++; render(); };
jumpBtn.onclick = ()=>{
  const p = parseInt(jumpInput.value);
  if(p>0){ page=p; render(); }
};

/* ===== EXPORT CSV ===== */
btnExport.onclick = ()=>{
  let csv = "Item No,Part No,Description,Category,Qty\n";
  all.forEach(r=>{
    csv+=`"${r["item no"]||""}","${r["part no"]||""}","${r["description"]||""}","${r["category"]||""}","${r["qty"]||""}"\n`;
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "spare_parts.csv";
  a.click();
};

/* ===== SCANNER ===== */
btnScan.onclick = ()=>{
  qrBackdrop.style.display="flex";
  scanner = new Html5Qrcode("qr-reader");
  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:{width:180,height:180} },
    txt=>{
      // SOUND
      beep.currentTime = 0;
      beep.play();

      // STRONG VIBRATION
      if(navigator.vibrate){
        navigator.vibrate([300,100,300,100,400]);
      }

      search.value = txt;
      highlightValue = txt;
      page = 1;
      render();

      scanner.stop();
      qrBackdrop.style.display="none";
    }
  );
};

qrClose.onclick = ()=>{
  if(scanner) scanner.stop();
  qrBackdrop.style.display="none";
};

/* ===== THEME ===== */
darkToggle.checked = localStorage.dark==="1";
compactToggle.checked = localStorage.compact==="1";
document.body.classList.toggle("dark", darkToggle.checked);
document.body.classList.toggle("compact", compactToggle.checked);

darkToggle.onchange = ()=>{
  document.body.classList.toggle("dark", darkToggle.checked);
  localStorage.dark = darkToggle.checked?"1":"";
};
compactToggle.onchange = ()=>{
  document.body.classList.toggle("compact", compactToggle.checked);
  localStorage.compact = compactToggle.checked?"1":"";
};

btnRefresh.onclick = load;

load();
</script>

</body>
</html>
